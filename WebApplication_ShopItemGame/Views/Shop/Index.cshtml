@model IEnumerable<WebApplication_ShopItemGame.Models.Product>

@{
    ViewData["Title"] = "Shop";
}

<div class="container-sm p-4 pt-1 pb-2">
    <center>
        <div class="col-12 col-lg-12 bg-white p-2 mb-2" style="border-radius: 1vh;">
            <div class="d-flex justify-content-between">
                <div class="text-center text-lg-start">
                    <h3 class="text-white m-0 main-color" style="padding: 5px 10px; border-radius: 1vh; width: fit-content;">
                        <i class="fa-solid fa-star"></i> สินค้าทั้งหมด
                    </h3>
                </div>
            </div>
        </div>
    </center>
</div>

<div class="row g-4 container-sm p-4 pt-1 pb-2">
    @foreach (var item in Model)
    {
        <div class="col-12 col-sm-6 col-md-4 col-lg-3">
            <div class="card h-100 shadow rounded product-card" style="border-radius: 1vh;">
                <a asp-controller="Shop" asp-action="Details" asp-route-id="@item.Id" class="text-decoration-none">
                    <img src="@Url.Content("~/Img/" + item.ImageUrl + ".png")" class="card-img-top rounded-top" alt="@item.Name" style="border-radius: 1vh 1vh 0 0; object-fit: cover; height: 250px;" />
                </a>
                <div class="card-body d-flex flex-column">
                    <p class="badge bg-colorPJ text-white mb-2 align-self-start" style=" border-radius: 1vh;">
                        สินค้าคงเหลือ @item.Stock ชิ้น
                    </p>
                    <h5 class="card-title text-dark flex-grow-1" style="word-break: break-word;">@item.Name</h5>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <p class="h5 text-main mb-0"><strong>@item.Price.ToString("N2")</strong> <span class="fs-6 text-dark">บาท</span></p>
                        </div>
                        @* ถ้ามีราคาปกติและราคาลด (แบบ del) เพิ่มตรงนี้ *@
                        @*<p class="text-muted mb-0"><del>@item.OldPrice.ToString("N2")</del></p>*@
                    </div>

                    @if (item.Stock > 0)
                    {
                        <a href="@Url.Action("Details", "Shop", new { id = item.Id })" class="btn bg-colorPJ w-100 mt-auto" style="border-radius: 1vh;">
                            สั่งซื้อเลย
                        </a>

                        <button class="btn btn-success w-100 mt-2 add-to-cart-btn" data-product-id="@item.Id" style="border-radius: 1vh;">
                            เพิ่มลงตะกร้า
                        </button>
                    }
                    else
                    {
                        <span class="btn btn-outline-danger fw-bold">สินค้าหมด</span>
                    }

                </div>
            </div>
        </div>
    }
</div>


@section Scripts {
    <script>
        document.querySelectorAll('.add-to-cart-btn').forEach(button => {
            button.addEventListener('click', function() {
                const productId = this.getAttribute('data-product-id');
                var isAuthenticated = @User.Identity.IsAuthenticated.ToString().ToLower();
        if (!isAuthenticated) {
            window.location.href = '@Url.Action("Login", "Auth")';
        }
                fetch('@Url.Action("AddToCartAjax", "Cart")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: new URLSearchParams({
                        productId: productId,
                        quantity: '1'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        const cartCountElem = document.getElementById('cart-count');
                        if (cartCountElem) {
                            cartCountElem.textContent = data.cartCount;
                            
                        } else {
                            console.warn('Element #cart-count not found!');
                        }
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('เกิดข้อผิดพลาด');
                });
            });
        });
    </script>
}


